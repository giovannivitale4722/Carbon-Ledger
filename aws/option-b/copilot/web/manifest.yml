# AWS Copilot manifest for Web service
# https://aws.github.io/copilot-cli/docs/manifest/lb-web-service/

name: web
type: Load Balanced Web Service

# Docker image configuration
image:
  build:
    context: ../../../
    dockerfile: apps/web/Dockerfile
  port: 3000

# CPU and memory
cpu: 256
memory: 512

# Number of tasks
count: 1

# Health check
http:
  path: /
  healthcheck:
    path: /
    healthy_threshold: 2
    unhealthy_threshold: 3
    interval: 15s
    timeout: 10s

# Routing (main entry point)
http:
  alias: web
  path: '/'
  routing_rule:
    path: '/'
    target_container: web

# Environment variables
variables:
  NODE_ENV: production
  PORT: 3000
  NEXT_TELEMETRY_DISABLED: 1

# Secrets from AWS Secrets Manager
secrets:
  NEXTAUTH_SECRET: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/NEXTAUTH_SECRET

# Public environment variables
environments:
  prod:
    variables:
      NEXT_PUBLIC_API_BASE: https://api.${COPILOT_APPLICATION_NAME}-${COPILOT_ENVIRONMENT_NAME}.com
      NEXTAUTH_URL: https://${COPILOT_APPLICATION_NAME}-${COPILOT_ENVIRONMENT_NAME}.com

# Observability
logging:
  retention: 30

