# AWS Copilot manifest for API service
# https://aws.github.io/copilot-cli/docs/manifest/lb-web-service/

name: api
type: Load Balanced Web Service

# Docker image configuration
image:
  build:
    context: ../../../
    dockerfile: apps/api/Dockerfile
  port: 4000

# CPU and memory
cpu: 256
memory: 512

# Number of tasks
count: 1

# Auto-scaling
exec: true

# Health check
http:
  path: /health
  healthcheck:
    path: /health
    healthy_threshold: 2
    unhealthy_threshold: 3
    interval: 15s
    timeout: 10s

# Routing
http:
  alias: api
  path: '*'

# Environment variables
variables:
  NODE_ENV: production
  PORT: 4000
  USE_LOCAL_EMISSION_DATA: true

# Secrets from AWS Secrets Manager
secrets:
  DATABASE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/DATABASE_URL
  JWT_SECRET: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/JWT_SECRET

# Observability
logging:
  retention: 30

# VPC configuration for RDS access
network:
  vpc:
    security_groups:
      - sg-12345678  # Replace with your RDS security group

# Task execution role (for pulling images and reading secrets)
taskdef_overrides:
  - path: ContainerDefinitions[0].LogConfiguration.Options.awslogs-stream-prefix
    value: api

